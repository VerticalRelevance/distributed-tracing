2025-01-27 16:08:43,420 - DEBUG - start __main__
DEBUG:analyze_source_ast.stderr:start __main__
2025-01-27 16:08:43,420 - DEBUG - start get_source_code
DEBUG:analyze_source_ast.stderr:start get_source_code
2025-01-27 16:08:43,420 - DEBUG - end get_source_code
DEBUG:analyze_source_ast.stderr:end get_source_code
2025-01-27 16:08:43,420 - DEBUG - start convert_to_hierarchical
DEBUG:analyze_source_ast.stderr:start convert_to_hierarchical
INFO:analyze_source_ast.stdout:Converting code to hierarchical structure
2025-01-27 16:08:43,420 - DEBUG - Attempt 1 of 1 for converting code to tree-style hierarchical structure
DEBUG:analyze_source_ast.stderr:Attempt 1 of 1 for converting code to tree-style hierarchical structure
2025-01-27 16:08:43,420 - DEBUG - start get_completion_with_retry
DEBUG:analyze_source_ast.stderr:start get_completion_with_retry
2025-01-27 16:08:43,420 - DEBUG - Get completion attempt:  (attempt 1/3)
DEBUG:analyze_source_ast.stderr:Get completion attempt:  (attempt 1/3)
INFO:analyze_source_ast.stdout:Attempting LLM call (attempt 1/3)
INFO:analyze_source_ast.stdout:Input messages: 
        Convert the following Python code into a tree-style hierarchical structure with multiple levels of sub-functions.
        Each significant step or logical block should be its own function, and functions can call other sub-functions.
        Ensure that the main function calls these sub-functions in the correct order, creating a tree-like structure.

        ### Original Code:
        # from https://github.com/getsentry/sentry-python/blob/master/sentry_sdk/ai/monitoring.py
import inspect
from functools import wraps

import sentry_sdk.utils
from sentry_sdk import start_span
from sentry_sdk.tracing import Span
from sentry_sdk.utils import ContextVar

from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from typing import Optional, Callable, Any

_ai_pipeline_name = ContextVar("ai_pipeline_name", default=None)


def set_ai_pipeline_name(name):
    # type: (Optional[str]) -> None
    _ai_pipeline_name.set(name)


def get_ai_pipeline_name():
    # type: () -> Optional[str]
    return _ai_pipeline_name.get()


def ai_track(description, **span_kwargs):
    # type: (str, Any) -> Callable[..., Any]
    def decorator(f):
        # type: (Callable[..., Any]) -> Callable[..., Any]
        def sync_wrapped(*args, **kwargs):
            # type: (Any, Any) -> Any
            curr_pipeline = _ai_pipeline_name.get()
            op = span_kwargs.get("op", "ai.run" if curr_pipeline else "ai.pipeline")

            with start_span(name=description, op=op, **span_kwargs) as span:
                for k, v in kwargs.pop("sentry_tags", {}).items():
                    span.set_tag(k, v)
                for k, v in kwargs.pop("sentry_data", {}).items():
                    span.set_data(k, v)
                if curr_pipeline:
                    span.set_data("ai.pipeline.name", curr_pipeline)
                    return f(*args, **kwargs)
                else:
                    _ai_pipeline_name.set(description)
                    try:
                        res = f(*args, **kwargs)
                    except Exception as e:
                        event, hint = sentry_sdk.utils.event_from_exception(
                            e,
                            client_options=sentry_sdk.get_client().options,
                            mechanism={"type": "ai_monitoring", "handled": False},
                        )
                        sentry_sdk.capture_event(event, hint=hint)
                        raise e from None
                    finally:
                        _ai_pipeline_name.set(None)
                    return res

        async def async_wrapped(*args, **kwargs):
            # type: (Any, Any) -> Any
            curr_pipeline = _ai_pipeline_name.get()
            op = span_kwargs.get("op", "ai.run" if curr_pipeline else "ai.pipeline")

            with start_span(name=description, op=op, **span_kwargs) as span:
                for k, v in kwargs.pop("sentry_tags", {}).items():
                    span.set_tag(k, v)
                for k, v in kwargs.pop("sentry_data", {}).items():
                    span.set_data(k, v)
                if curr_pipeline:
                    span.set_data("ai.pipeline.name", curr_pipeline)
                    return await f(*args, **kwargs)
                else:
                    _ai_pipeline_name.set(description)
                    try:
                        res = await f(*args, **kwargs)
                    except Exception as e:
                        event, hint = sentry_sdk.utils.event_from_exception(
                            e,
                            client_options=sentry_sdk.get_client().options,
                            mechanism={"type": "ai_monitoring", "handled": False},
                        )
                        sentry_sdk.capture_event(event, hint=hint)
                        raise e from None
                    finally:
                        _ai_pipeline_name.set(None)
                    return res

        if inspect.iscoroutinefunction(f):
            return wraps(f)(async_wrapped)
        else:
            return wraps(f)(sync_wrapped)

    return decorator


def record_token_usage(
    span, prompt_tokens=None, completion_tokens=None, total_tokens=None
):
    # type: (Span, Optional[int], Optional[int], Optional[int]) -> None
    ai_pipeline_name = get_ai_pipeline_name()
    if ai_pipeline_name:
        span.set_data("ai.pipeline.name", ai_pipeline_name)
    if prompt_tokens is not None:
        span.set_measurement("ai_prompt_tokens_used", value=prompt_tokens)
    if completion_tokens is not None:
        span.set_measurement("ai_completion_tokens_used", value=completion_tokens)
    if (
        total_tokens is None
        and prompt_tokens is not None
        and completion_tokens is not None
    ):
        total_tokens = prompt_tokens + completion_tokens
    if total_tokens is not None:
        span.set_measurement("ai_total_tokens_used", total_tokens)

        

        ### Instructions:
        Please first analyze the codes step by step, and then provide the converted code in a Python code block (```python ... ```). When providing the final converted code, make sure to include all the functions in a flattened format, where each function is defined separately.
        
DEBUG:openai._base_client:Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'json_data': {'messages': [{'role': 'system', 'content': 'You are an AI assistant specialized in refactoring Python code into a tree-style hierarchical structure.'}, {'role': 'user', 'content': '\n        Convert the following Python code into a tree-style hierarchical structure with multiple levels of sub-functions.\n        Each significant step or logical block should be its own function, and functions can call other sub-functions.\n        Ensure that the main function calls these sub-functions in the correct order, creating a tree-like structure.\n\n        ### Original Code:\n        # from https://github.com/getsentry/sentry-python/blob/master/sentry_sdk/ai/monitoring.py\nimport inspect\nfrom functools import wraps\n\nimport sentry_sdk.utils\nfrom sentry_sdk import start_span\nfrom sentry_sdk.tracing import Span\nfrom sentry_sdk.utils import ContextVar\n\nfrom typing import TYPE_CHECKING\n\nif TYPE_CHECKING:\n    from typing import Optional, Callable, Any\n\n_ai_pipeline_name = ContextVar("ai_pipeline_name", default=None)\n\n\ndef set_ai_pipeline_name(name):\n    # type: (Optional[str]) -> None\n    _ai_pipeline_name.set(name)\n\n\ndef get_ai_pipeline_name():\n    # type: () -> Optional[str]\n    return _ai_pipeline_name.get()\n\n\ndef ai_track(description, **span_kwargs):\n    # type: (str, Any) -> Callable[..., Any]\n    def decorator(f):\n        # type: (Callable[..., Any]) -> Callable[..., Any]\n        def sync_wrapped(*args, **kwargs):\n            # type: (Any, Any) -> Any\n            curr_pipeline = _ai_pipeline_name.get()\n            op = span_kwargs.get("op", "ai.run" if curr_pipeline else "ai.pipeline")\n\n            with start_span(name=description, op=op, **span_kwargs) as span:\n                for k, v in kwargs.pop("sentry_tags", {}).items():\n                    span.set_tag(k, v)\n                for k, v in kwargs.pop("sentry_data", {}).items():\n                    span.set_data(k, v)\n                if curr_pipeline:\n                    span.set_data("ai.pipeline.name", curr_pipeline)\n                    return f(*args, **kwargs)\n                else:\n                    _ai_pipeline_name.set(description)\n                    try:\n                        res = f(*args, **kwargs)\n                    except Exception as e:\n                        event, hint = sentry_sdk.utils.event_from_exception(\n                            e,\n                            client_options=sentry_sdk.get_client().options,\n                            mechanism={"type": "ai_monitoring", "handled": False},\n                        )\n                        sentry_sdk.capture_event(event, hint=hint)\n                        raise e from None\n                    finally:\n                        _ai_pipeline_name.set(None)\n                    return res\n\n        async def async_wrapped(*args, **kwargs):\n            # type: (Any, Any) -> Any\n            curr_pipeline = _ai_pipeline_name.get()\n            op = span_kwargs.get("op", "ai.run" if curr_pipeline else "ai.pipeline")\n\n            with start_span(name=description, op=op, **span_kwargs) as span:\n                for k, v in kwargs.pop("sentry_tags", {}).items():\n                    span.set_tag(k, v)\n                for k, v in kwargs.pop("sentry_data", {}).items():\n                    span.set_data(k, v)\n                if curr_pipeline:\n                    span.set_data("ai.pipeline.name", curr_pipeline)\n                    return await f(*args, **kwargs)\n                else:\n                    _ai_pipeline_name.set(description)\n                    try:\n                        res = await f(*args, **kwargs)\n                    except Exception as e:\n                        event, hint = sentry_sdk.utils.event_from_exception(\n                            e,\n                            client_options=sentry_sdk.get_client().options,\n                            mechanism={"type": "ai_monitoring", "handled": False},\n                        )\n                        sentry_sdk.capture_event(event, hint=hint)\n                        raise e from None\n                    finally:\n                        _ai_pipeline_name.set(None)\n                    return res\n\n        if inspect.iscoroutinefunction(f):\n            return wraps(f)(async_wrapped)\n        else:\n            return wraps(f)(sync_wrapped)\n\n    return decorator\n\n\ndef record_token_usage(\n    span, prompt_tokens=None, completion_tokens=None, total_tokens=None\n):\n    # type: (Span, Optional[int], Optional[int], Optional[int]) -> None\n    ai_pipeline_name = get_ai_pipeline_name()\n    if ai_pipeline_name:\n        span.set_data("ai.pipeline.name", ai_pipeline_name)\n    if prompt_tokens is not None:\n        span.set_measurement("ai_prompt_tokens_used", value=prompt_tokens)\n    if completion_tokens is not None:\n        span.set_measurement("ai_completion_tokens_used", value=completion_tokens)\n    if (\n        total_tokens is None\n        and prompt_tokens is not None\n        and completion_tokens is not None\n    ):\n        total_tokens = prompt_tokens + completion_tokens\n    if total_tokens is not None:\n        span.set_measurement("ai_total_tokens_used", total_tokens)\n\n        \n\n        ### Instructions:\n        Please first analyze the codes step by step, and then provide the converted code in a Python code block (```python ... ```). When providing the final converted code, make sure to include all the functions in a flattened format, where each function is defined separately.\n        '}], 'model': 'gpt-4o-mini', 'temperature': 0.0}}
DEBUG:openai._base_client:Sending HTTP Request: POST https://api.openai.com/v1/chat/completions
DEBUG:openai._base_client:HTTP Response: POST https://api.openai.com/v1/chat/completions "200 OK" Headers([('date', 'Mon, 27 Jan 2025 21:09:00 GMT'), ('content-type', 'application/json'), ('transfer-encoding', 'chunked'), ('connection', 'keep-alive'), ('access-control-expose-headers', 'X-Request-ID'), ('openai-organization', 'vertical-relevance-p5p59n'), ('openai-processing-ms', '16546'), ('openai-version', '2020-10-01'), ('x-ratelimit-limit-requests', '30000'), ('x-ratelimit-limit-tokens', '150000000'), ('x-ratelimit-remaining-requests', '29999'), ('x-ratelimit-remaining-tokens', '149998641'), ('x-ratelimit-reset-requests', '2ms'), ('x-ratelimit-reset-tokens', '0s'), ('x-request-id', 'req_32880e261e661739eac291860e3ac111'), ('strict-transport-security', 'max-age=31536000; includeSubDomains; preload'), ('cf-cache-status', 'DYNAMIC'), ('set-cookie', '__cf_bm=pphUch9FKcqsWVqtcghNc5lbAixJi7DwdjCj8TI8_Do-1738012140-1.0.1.1-g_9jFreBc6Xv8Q6bRtzzK7GALl6SljcZ7WKg0NcJK8PVlMtCKA7o96TJpYWglJ24.AJVHmA9rT2D05EtJbCpvg; path=/; expires=Mon, 27-Jan-25 21:39:00 GMT; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), ('x-content-type-options', 'nosniff'), ('set-cookie', '_cfuvid=Z4PFYA.98GJwwWZ8MzSTwmdyTd4WCmMArUqz77q8s3c-1738012140328-0.0.1.1-604800000; path=/; domain=.api.openai.com; HttpOnly; Secure; SameSite=None'), ('server', 'cloudflare'), ('cf-ray', '908bb83d0a058dc6-MIA'), ('content-encoding', 'gzip'), ('alt-svc', 'h3=":443"; ma=86400')])
DEBUG:openai._base_client:request_id: req_32880e261e661739eac291860e3ac111
INFO:analyze_source_ast.stdout:LLM response: To convert the provided Python code into a tree-style hierarchical structure, we will break down the code into logical blocks and create separate functions for each significant step. The main function will call these sub-functions in the correct order, creating a clear hierarchy.

### Analysis of the Code

1. **Context Variable Management**:
   - `set_ai_pipeline_name(name)`: Sets the AI pipeline name.
   - `get_ai_pipeline_name()`: Retrieves the current AI pipeline name.

2. **Decorator for Tracking**:
   - `ai_track(description, **span_kwargs)`: A decorator that wraps functions to track their execution with Sentry spans.
     - Inside this, we have:
       - `sync_wrapped(*args, **kwargs)`: Synchronous wrapper for the function.
       - `async_wrapped(*args, **kwargs)`: Asynchronous wrapper for the function.

3. **Token Usage Recording**:
   - `record_token_usage(span, prompt_tokens=None, completion_tokens=None, total_tokens=None)`: Records token usage metrics.

### Refactored Code Structure

Now, we will create a tree-like structure with the main function and sub-functions.

```python
import inspect
from functools import wraps
import sentry_sdk.utils
from sentry_sdk import start_span
from sentry_sdk.tracing import Span
from sentry_sdk.utils import ContextVar
from typing import TYPE_CHECKING, Optional, Callable, Any

if TYPE_CHECKING:
    pass

_ai_pipeline_name = ContextVar("ai_pipeline_name", default=None)

def main_function():
    # Main entry point for the AI tracking functionality
    pass  # This can be expanded based on how the main function is intended to be used

def set_ai_pipeline_name(name: Optional[str]) -> None:
    _ai_pipeline_name.set(name)

def get_ai_pipeline_name() -> Optional[str]:
    return _ai_pipeline_name.get()

def ai_track(description: str, **span_kwargs: Any) -> Callable[..., Any]:
    def decorator(f: Callable[..., Any]) -> Callable[..., Any]:
        return wraps(f)(sync_wrapped(f, description, span_kwargs)) if not inspect.iscoroutinefunction(f) else wraps(f)(async_wrapped(f, description, span_kwargs))
    
    return decorator

def sync_wrapped(f: Callable[..., Any], description: str, span_kwargs: Any) -> Callable[..., Any]:
    def wrapper(*args, **kwargs) -> Any:
        curr_pipeline = get_ai_pipeline_name()
        op = span_kwargs.get("op", "ai.run" if curr_pipeline else "ai.pipeline")
        with start_span(name=description, op=op, **span_kwargs) as span:
            set_span_tags_and_data(span, kwargs)
            if curr_pipeline:
                span.set_data("ai.pipeline.name", curr_pipeline)
                return f(*args, **kwargs)
            else:
                set_ai_pipeline_name(description)
                try:
                    res = f(*args, **kwargs)
                except Exception as e:
                    handle_exception(e)
                    raise e from None
                finally:
                    set_ai_pipeline_name(None)
                return res
    return wrapper

def async_wrapped(f: Callable[..., Any], description: str, span_kwargs: Any) -> Callable[..., Any]:
    async def wrapper(*args, **kwargs) -> Any:
        curr_pipeline = get_ai_pipeline_name()
        op = span_kwargs.get("op", "ai.run" if curr_pipeline else "ai.pipeline")
        with start_span(name=description, op=op, **span_kwargs) as span:
            set_span_tags_and_data(span, kwargs)
            if curr_pipeline:
                span.set_data("ai.pipeline.name", curr_pipeline)
                return await f(*args, **kwargs)
            else:
                set_ai_pipeline_name(description)
                try:
                    res = await f(*args, **kwargs)
                except Exception as e:
                    handle_exception(e)
                    raise e from None
                finally:
                    set_ai_pipeline_name(None)
                return res
    return wrapper

def set_span_tags_and_data(span, kwargs):
    for k, v in kwargs.pop("sentry_tags", {}).items():
        span.set_tag(k, v)
    for k, v in kwargs.pop("sentry_data", {}).items():
        span.set_data(k, v)

def handle_exception(e: Exception):
    event, hint = sentry_sdk.utils.event_from_exception(
        e,
        client_options=sentry_sdk.get_client().options,
        mechanism={"type": "ai_monitoring", "handled": False},
    )
    sentry_sdk.capture_event(event, hint=hint)

def record_token_usage(span: Span, prompt_tokens: Optional[int] = None, completion_tokens: Optional[int] = None, total_tokens: Optional[int] = None) -> None:
    ai_pipeline_name = get_ai_pipeline_name()
    if ai_pipeline_name:
        span.set_data("ai.pipeline.name", ai_pipeline_name)
    if prompt_tokens is not None:
        span.set_measurement("ai_prompt_tokens_used", value=prompt_tokens)
    if completion_tokens is not None:
        span.set_measurement("ai_completion_tokens_used", value=completion_tokens)
    if total_tokens is None and prompt_tokens is not None and completion_tokens is not None:
        total_tokens = prompt_tokens + completion_tokens
    if total_tokens is not None:
        span.set_measurement("ai_total_tokens_used", total_tokens)
```

### Explanation of the Refactored Code

- **Main Function**: `main_function()` serves as the entry point for the AI tracking functionality.
- **Context Management**: Functions `set_ai_pipeline_name` and `get_ai_pipeline_name` manage the context variable.
- **Decorator**: `ai_track` is the main decorator that decides whether to use synchronous or asynchronous wrapping.
- **Synchronous and Asynchronous Wrappers**: `sync_wrapped` and `async_wrapped` handle the function execution and span management.
- **Span Management**: `set_span_tags_and_data` sets tags and data for the span, while `handle_exception` captures exceptions.
- **Token Usage Recording**: `record_token_usage` records the token usage metrics.

This structure provides a clear hierarchy and separation of concerns, making the code easier to read and maintain.
INFO:analyze_source_ast.stdout:LLM call received
2025-01-27 16:09:00,344 - DEBUG - end get_completion_with_retry
DEBUG:analyze_source_ast.stderr:end get_completion_with_retry
2025-01-27 16:09:00,344 - DEBUG - start extract_code_blocks
DEBUG:analyze_source_ast.stderr:start extract_code_blocks
2025-01-27 16:09:00,344 - DEBUG - end extract_code_blocks
DEBUG:analyze_source_ast.stderr:end extract_code_blocks
2025-01-27 16:09:00,345 - DEBUG - start extract_functions
DEBUG:analyze_source_ast.stderr:start extract_functions
INFO:analyze_source_ast.stdout:Extracting functions from code
INFO:analyze_source_ast.stdout:Extracted 11 functions: main_function, set_ai_pipeline_name, get_ai_pipeline_name, ai_track, sync_wrapped, async_wrapped, set_span_tags_and_data, handle_exception, record_token_usage, decorator, wrapper
2025-01-27 16:09:00,348 - DEBUG - end extract_functions
DEBUG:analyze_source_ast.stderr:end extract_functions
INFO:analyze_source_ast.stdout:Converted code to tree-style hierarchical structure with 10 sub-functions
2025-01-27 16:09:00,348 - DEBUG - start split_nested_functions
DEBUG:analyze_source_ast.stderr:start split_nested_functions
2025-01-27 16:09:00,350 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,350 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,350 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,350 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,350 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,351 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - start extract_functions_from_code
DEBUG:analyze_source_ast.stderr:start extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end extract_functions_from_code
DEBUG:analyze_source_ast.stderr:end extract_functions_from_code
2025-01-27 16:09:00,352 - DEBUG - end split_nested_functions
DEBUG:analyze_source_ast.stderr:end split_nested_functions
2025-01-27 16:09:00,354 - DEBUG - end convert_to_hierarchical: best conversion
DEBUG:analyze_source_ast.stderr:end convert_to_hierarchical: best conversion
INFO:analyze_source_ast.stdout:Converted code to tree-style hierarchical structure:
def main_function():
    pass

def set_ai_pipeline_name(name: Optional[str]) -> None:
    _ai_pipeline_name.set(name)

def get_ai_pipeline_name() -> Optional[str]:
    return _ai_pipeline_name.get()

def ai_track(description: str, **span_kwargs: Any) -> Callable[..., Any]:
    return decorator

def decorator(f: Callable[..., Any]) -> Callable[..., Any]:
    return wraps(f)(sync_wrapped(f, description, span_kwargs)) if not inspect.iscoroutinefunction(f) else wraps(f)(async_wrapped(f, description, span_kwargs))

def sync_wrapped(f: Callable[..., Any], description: str, span_kwargs: Any) -> Callable[..., Any]:
    return wrapper

def wrapper(*args, **kwargs) -> Any:
    curr_pipeline = get_ai_pipeline_name()
    op = span_kwargs.get('op', 'ai.run' if curr_pipeline else 'ai.pipeline')
    with start_span(name=description, op=op, **span_kwargs) as span:
        set_span_tags_and_data(span, kwargs)
        if curr_pipeline:
            span.set_data('ai.pipeline.name', curr_pipeline)
            return f(*args, **kwargs)
        else:
            set_ai_pipeline_name(description)
            try:
                res = f(*args, **kwargs)
            except Exception as e:
                handle_exception(e)
                raise e from None
            finally:
                set_ai_pipeline_name(None)
            return res

def async_wrapped(f: Callable[..., Any], description: str, span_kwargs: Any) -> Callable[..., Any]:

    async def wrapper(*args, **kwargs) -> Any:
        curr_pipeline = get_ai_pipeline_name()
        op = span_kwargs.get('op', 'ai.run' if curr_pipeline else 'ai.pipeline')
        with start_span(name=description, op=op, **span_kwargs) as span:
            set_span_tags_and_data(span, kwargs)
            if curr_pipeline:
                span.set_data('ai.pipeline.name', curr_pipeline)
                return await f(*args, **kwargs)
            else:
                set_ai_pipeline_name(description)
                try:
                    res = await f(*args, **kwargs)
                except Exception as e:
                    handle_exception(e)
                    raise e from None
                finally:
                    set_ai_pipeline_name(None)
                return res
    return wrapper

def set_span_tags_and_data(span, kwargs):
    for k, v in kwargs.pop('sentry_tags', {}).items():
        span.set_tag(k, v)
    for k, v in kwargs.pop('sentry_data', {}).items():
        span.set_data(k, v)

def handle_exception(e: Exception):
    event, hint = sentry_sdk.utils.event_from_exception(e, client_options=sentry_sdk.get_client().options, mechanism={'type': 'ai_monitoring', 'handled': False})
    sentry_sdk.capture_event(event, hint=hint)

def record_token_usage(span: Span, prompt_tokens: Optional[int]=None, completion_tokens: Optional[int]=None, total_tokens: Optional[int]=None) -> None:
    ai_pipeline_name = get_ai_pipeline_name()
    if ai_pipeline_name:
        span.set_data('ai.pipeline.name', ai_pipeline_name)
    if prompt_tokens is not None:
        span.set_measurement('ai_prompt_tokens_used', value=prompt_tokens)
    if completion_tokens is not None:
        span.set_measurement('ai_completion_tokens_used', value=completion_tokens)
    if total_tokens is None and prompt_tokens is not None and (completion_tokens is not None):
        total_tokens = prompt_tokens + completion_tokens
    if total_tokens is not None:
        span.set_measurement('ai_total_tokens_used', total_tokens)
2025-01-27 16:09:00,354 - DEBUG - start extract_functions
DEBUG:analyze_source_ast.stderr:start extract_functions
INFO:analyze_source_ast.stdout:Extracting functions from code
INFO:analyze_source_ast.stdout:Extracted 11 functions: main_function, set_ai_pipeline_name, get_ai_pipeline_name, ai_track, decorator, sync_wrapped, wrapper, async_wrapped, set_span_tags_and_data, handle_exception, record_token_usage
2025-01-27 16:09:00,356 - DEBUG - end extract_functions
DEBUG:analyze_source_ast.stderr:end extract_functions
2025-01-27 16:09:00,356 - DEBUG - start extract_imports
DEBUG:analyze_source_ast.stderr:start extract_imports
INFO:analyze_source_ast.stdout:Extracting imports from code
INFO:analyze_source_ast.stdout:Extracted 10 imports: inspect, wraps, sentry_sdk.utils, start_span, Span, ContextVar, TYPE_CHECKING, Optional, Callable, Any
2025-01-27 16:09:00,357 - DEBUG - end extract_imports
DEBUG:analyze_source_ast.stderr:end extract_imports
2025-01-27 16:09:00,357 - DEBUG - start create_dependency_graph
DEBUG:analyze_source_ast.stderr:start create_dependency_graph
2025-01-27 16:09:00,357 - DEBUG - end create_dependency_graph
DEBUG:analyze_source_ast.stderr:end create_dependency_graph
2025-01-27 16:09:00,357 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,357 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,357 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,357 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,357 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,357 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,357 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,358 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,359 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - start get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:start get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str
2025-01-27 16:09:00,360 - DEBUG - end get_dependency_graph_str root is None
DEBUG:analyze_source_ast.stderr:end get_dependency_graph_str root is None
INFO:analyze_source_ast.stdout:Dependency graph:
├── main_function
├── ai_track
│   ├── Any
│   ├── Callable
│   └── decorator
│       ├── Any
│       ├── Callable
│       ├── async_wrapped
│       │   ├── Any
│       │   ├── Callable
│       │   ├── get_ai_pipeline_name
│       │   │   └── Optional
│       │   ├── handle_exception
│       │   │   └── sentry_sdk.utils
│       │   ├── set_ai_pipeline_name
│       │   │   └── Optional
│       │   ├── set_span_tags_and_data
│       │   ├── start_span
│       │   ├── sync_wrapped
│       │   │   ├── Any
│       │   │   ├── Callable
│       │   │   └── wrapper
│       │   │       ├── Any
│       │   │       ├── get_ai_pipeline_name
│       │   │       │   └── Optional
│       │   │       ├── handle_exception
│       │   │       │   └── sentry_sdk.utils
│       │   │       ├── set_ai_pipeline_name
│       │   │       │   └── Optional
│       │   │       ├── set_span_tags_and_data
│       │   │       └── start_span
│       │   └── wrapper
│       │       ├── Any
│       │       ├── get_ai_pipeline_name
│       │       │   └── Optional
│       │       ├── handle_exception
│       │       │   └── sentry_sdk.utils
│       │       ├── set_ai_pipeline_name
│       │       │   └── Optional
│       │       ├── set_span_tags_and_data
│       │       └── start_span
│       ├── inspect
│       ├── sync_wrapped
│       │   ├── Any
│       │   ├── Callable
│       │   └── wrapper
│       │       ├── Any
│       │       ├── get_ai_pipeline_name
│       │       │   └── Optional
│       │       ├── handle_exception
│       │       │   └── sentry_sdk.utils
│       │       ├── set_ai_pipeline_name
│       │       │   └── Optional
│       │       ├── set_span_tags_and_data
│       │       └── start_span
│       └── wraps
├── record_token_usage
│   ├── Optional
│   ├── Span
│   └── get_ai_pipeline_name
│       └── Optional
├── ContextVar
│   └── sentry_sdk.utils
└── TYPE_CHECKING
2025-01-27 16:09:00,360 - DEBUG - start topological_sort
DEBUG:analyze_source_ast.stderr:start topological_sort
2025-01-27 16:09:00,360 - DEBUG - end topological_sort
DEBUG:analyze_source_ast.stderr:end topological_sort
INFO:analyze_source_ast.stdout:Sorted functions: ['main_function', 'Optional', 'set_ai_pipeline_name', 'get_ai_pipeline_name', 'Callable', 'Any', 'start_span', 'sentry_sdk.utils', 'handle_exception', 'set_span_tags_and_data', 'wrapper', 'sync_wrapped', 'async_wrapped', 'wraps', 'inspect', 'decorator', 'ai_track', 'Span', 'record_token_usage', 'ContextVar', 'TYPE_CHECKING']
2025-01-27 16:09:00,360 - DEBUG - end __main__
DEBUG:analyze_source_ast.stderr:end __main__
